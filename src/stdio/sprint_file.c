/******************************************************************************
 *	Copyright (C) 2017	Alejandro Colomar Andr√©s		      *
 *	SPDX-License-Identifier:	LGPL-2.0-only			      *
 ******************************************************************************/


/******************************************************************************
 ******* headers **************************************************************
 ******************************************************************************/
#include "libalx/stdio/sprint_file.h"

#include <errno.h>
#include <stddef.h>
#include <stdio.h>

#include "libalx/stdlib/minimum.h"


/******************************************************************************
 ******* macros ***************************************************************
 ******************************************************************************/
#define _snprint_file	_snprint_file_fread


/******************************************************************************
 ******* enums ****************************************************************
 ******************************************************************************/


/******************************************************************************
 ******* structs / unions *****************************************************
 ******************************************************************************/


/******************************************************************************
 ******* variables ************************************************************
 ******************************************************************************/


/******************************************************************************
 ******* static functions (prototypes) ****************************************
 ******************************************************************************/
static	ptrdiff_t	_snprint_file_getc	(ptrdiff_t size,
						char dest[restrict size],
						FILE *fp);
static	ptrdiff_t	_snprint_file_fread	(ptrdiff_t size,
						char dest[restrict size],
						FILE *fp);


/******************************************************************************
 ******* global functions *****************************************************
 ******************************************************************************/
ptrdiff_t	alx_snprint_file(ptrdiff_t size,
				char dest[restrict size],
				const char fpath[restrict FILENAME_MAX])
{
	FILE		*fp;
	ptrdiff_t	len;

	fp	= fopen(fpath, "r");
	if (!fp)
		return	-1;

	len	= _snprint_file(size, dest, fp);
	fclose(fp);

	return	len;
}


/******************************************************************************
 ******* static functions (definitions) ***************************************
 ******************************************************************************/
static	ptrdiff_t	_snprint_file_getc	(ptrdiff_t size,
						char dest[restrict size],
						FILE *fp)
{
	ptrdiff_t	len;
	int		c;

	for (len = 0; len < size; len++) {
		c = getc(fp);
		if (c == EOF) {
			dest[len--] = '\0';
			break;
		}
		dest[len] = c;
	}

	return	len;
}

static	ptrdiff_t	_snprint_file_fread	(ptrdiff_t size,
						char dest[restrict size],
						FILE *fp)
{
	ptrdiff_t	len;

	fseek(fp, 0, SEEK_END);
	len	= ftell(fp);
	fseek(fp, 0, SEEK_SET);

	fread(dest, sizeof(char), MIN(len, size), fp);
	if (len < size)
		dest[len + 1]	= '\0';

	return	len;
}


/******************************************************************************
 ******* end of file **********************************************************
 ******************************************************************************/
